# ï¿½ Supabase + React - Complete Concepts Guide

> **Your personal learning journal for mastering Supabase backend integration**

---

## ðŸ“– Table of Contents

1. [ðŸŽ¯ What is Supabase?](#what-is-supabase)
2. [ðŸ” Authentication](#authentication)
3. [ðŸ—„ï¸ Database Tables & Relationships](#database-tables)
4. [ðŸ”— Foreign Keys](#foreign-keys)
5. [âš¡ Database Triggers](#triggers)
6. [ðŸ›¡ï¸ Row Level Security (RLS)](#rls)
7. [ðŸ”„ Realtime Subscriptions](#realtime)
8. [ðŸ§© SQL JOINs](#joins)

---

## ðŸŽ¯ What is Supabase? {#what-is-supabase}

> **Supabase = Firebase Alternative (but better!)**  
> Open-source backend-as-a-service built on PostgreSQL

### What it gives you:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Your React App            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ @supabase/supabase-js
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Supabase                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Authentication (auth.users)   â”‚
â”‚ âœ… PostgreSQL Database           â”‚
â”‚ âœ… Realtime Subscriptions        â”‚
â”‚ âœ… Row Level Security            â”‚
â”‚ âœ… Storage (files)               â”‚
â”‚ âœ… Edge Functions                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**In our project:**
- No backend server needed!
- Supabase handles auth, database, and security
- Just install `@supabase/supabase-js` and connect!

---

## ðŸ” Authentication {#authentication}

### Setting up Supabase Client

```javascript
// supabase-client.js
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.VITE_SUPABASE_URL,
  process.env.VITE_SUPABASE_KEY
);

export default supabase;
```

### Sign Up with Metadata

```javascript
const { data, error } = await supabase.auth.signUp({
  email: email.toLowerCase(),
  password: password,
  options: {
    data: {
      name: name,              // ðŸ‘ˆ Custom user data
      account_type: accountType // ðŸ‘ˆ "rep" or "admin"
    }
  }
});
```

ðŸ’¡ **Important:** Data in `options.data` gets stored in `raw_user_meta_data` field!

### Sign In

```javascript
const { data, error } = await supabase.auth.signInWithPassword({
  email: email.toLowerCase(),
  password: password
});
```

### Sign Out

```javascript
const { error } = await supabase.auth.signOut();
```

### Managing Session State

```javascript
// AuthContext.jsx
const [session, setSession] = useState(undefined);

useEffect(() => {
  // Get initial session
  supabase.auth.getSession().then(({ data }) => {
    setSession(data.session);
  });

  // Listen for auth changes
  supabase.auth.onAuthStateChange((_event, session) => {
    setSession(session); // Updates when: login, logout, token refresh
  });
}, []);
```

**When does session change?**
- âœ… User signs in â†’ `session` goes from `null` to `{user data}`
- âœ… User signs out â†’ `session` goes from `{user data}` to `null`
- âœ… Page refresh â†’ Session gets re-fetched
- âœ… Token refresh â†’ Supabase auto-refreshes tokens

---

## ðŸ—„ï¸ Database Tables & Relationships {#database-tables}

### Our Database Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  auth.users     â”‚         â”‚  user_profiles   â”‚
â”‚  (Supabase)     â”‚         â”‚  (Our table)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤ id (PK, FK)      â”‚
â”‚ email           â”‚         â”‚ name             â”‚
â”‚ encrypted_pw    â”‚         â”‚ account_type     â”‚
â”‚ raw_user_meta_  â”‚         â”‚ created_at       â”‚
â”‚   data (JSON)   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â–²
                                      â”‚ FK
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   sales_deals       â”‚
                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                           â”‚ id (PK)             â”‚
                           â”‚ user_id (FK) â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ value               â”‚
                           â”‚ created_at          â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Table Purposes

| Table | Purpose | Key Columns |
|-------|---------|-------------|
| `auth.users` | Supabase managed auth | `id`, `email`, `raw_user_meta_data` |
| `user_profiles` | Our custom user data | `id`, `name`, `account_type` |
| `sales_deals` | Deal records | `id`, `user_id`, `value` |

---

## ðŸ”— Foreign Keys (FK) {#foreign-keys}

> **What is a Foreign Key?**  
> A column that creates a link between two tables by referencing another table's primary key.

### ðŸŽ¯ How Foreign Keys Work

**In our app:** `sales_deals.user_id â†’ user_profiles.id`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚sales_deals  â”‚         â”‚user_profiles â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚user_id (FK) â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚id (PK)       â”‚
â”‚value        â”‚         â”‚name          â”‚
â”‚created_at   â”‚         â”‚account_type  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ðŸš¦ FK Validation Process

When you try to insert a deal with `user_id = "abc123"`:

1. **ðŸ” Check:** FK says *"Wait! Let me check `user_profiles` table..."*
2. **â“ Question:** Does `id = "abc123"` exist in `user_profiles`?
   - âœ… **YES** â†’ *"Okay, insert the deal!"*
   - âŒ **NO** â†’ *"ERROR! This user doesn't exist. Deal rejected!"*

### ðŸ”„ Real-World Flow

```javascript
// Step 1: User signs up
await supabase.auth.signUp({ email, password });
// âœ… Trigger creates user in user_profiles

// Step 2: User tries to add deal
const newDeal = { user_id: currentUser.id, value: 1000 };
// âœ… FK checks: "Is this user in user_profiles?"

// Step 3: Deal gets inserted
await supabase.from("sales_deals").insert(newDeal);
// âœ… Success! User exists!
```

### ðŸ’¡ Benefits of Foreign Keys

| Feature | Description |
|---------|-------------|
| **Data Integrity** | Prevents orphan records (deals without users) |
| **Automatic JOINs** | Enables Supabase spread syntax `...table!inner()` |
| **Cascading Actions** | Auto-delete deals when user is deleted |
| **Safety** | Database enforces rules, not just app code |

### Creating a Foreign Key

```sql
ALTER TABLE public.sales_deals 
ADD CONSTRAINT sales_deals_user_id_fkey 
FOREIGN KEY (user_id) 
REFERENCES public.user_profiles(id) ON DELETE CASCADE;
```

**Key Takeaway:** FK = Database Bouncer ðŸšª  
*"You're not on the list (`user_profiles`)? You can't make deals!"*

---

## âš¡ Database Triggers {#triggers}

> **What is a Trigger?**  
> Automatic code that runs when something happens in the database (like a robot watcher!)

### Why We Need Triggers

**Problem:** When user signs up, they're created in `auth.users` but NOT in `user_profiles`  
**Solution:** Trigger automatically creates profile when signup happens!

### Our Trigger Setup

```sql
-- STEP 1: Create the function (what to do)
create function public.handle_new_user()
returns trigger 
language plpgsql 
security definer
set search_path = ''
as $$ 
begin
  insert into public.user_profiles (id, name, account_type)
  values (
    new.id,
    new.raw_user_meta_data ->> 'name',
    new.raw_user_meta_data ->> 'account_type'
  );
  return new;
end;
$$;

-- STEP 2: Create the trigger (when to run it)
create trigger on_auth_user_created
  after insert on auth.users
  for each row 
  execute procedure public.handle_new_user();
```

### How It Works

```
User signs up with email + password + metadata
              â†“
    Supabase creates row in auth.users
              â†“
    ðŸ”¥ TRIGGER FIRES! ðŸ”¥
              â†“
    Extracts name & account_type from raw_user_meta_data
              â†“
    Creates matching row in user_profiles
              â†“
    âœ… User now exists in BOTH tables!
```

### Key Concepts

- `new` = the newly inserted row from `auth.users`
- `->>` = PostgreSQL JSON extraction operator (gets text value)
- `after insert` = runs AFTER the user is created
- `for each row` = runs once per new user

---

## ðŸ›¡ï¸ Row Level Security (RLS) {#rls}

> **What is RLS?**  
> Database-level security that controls who can read/write specific rows

### Why RLS Matters

Without RLS, **anyone** can insert/read ANY data!  
With RLS, **database enforces** who can access what!

### Our RLS Policies

#### Policy 1: Reps can only add their own deals

```sql
CREATE POLICY "Reps can only add their own deals"
ON public.sales_deals
FOR INSERT
TO authenticated
WITH CHECK (
  auth.uid() = user_id
  AND EXISTS (
    SELECT 1 FROM user_profiles
    WHERE user_profiles.id = auth.uid()
    AND user_profiles.account_type = 'rep'
  )
);
```

**Translation:**
- Only logged-in users (`authenticated`)
- Deal's `user_id` must match current user's ID (`auth.uid()`)
- User must have `account_type = 'rep'`

#### Policy 2: Admins can add anyone's deals

```sql
CREATE POLICY "Admins to add anyone's deals"
ON public.sales_deals
FOR INSERT
TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1 FROM user_profiles
    WHERE user_profiles.id = auth.uid()
    AND user_profiles.account_type = 'admin'
  )
);
```

**Translation:**
- Only logged-in users
- User must have `account_type = 'admin'`
- No `user_id` check â†’ can add deals for anyone!

### How Policies Work Together

```javascript
// Rep trying to add deal
const repDeal = { user_id: "rep-123", value: 1000 };
await supabase.from("sales_deals").insert(repDeal);
// âœ… Policy 1 checks: Is user_id = current user? Is user a rep? â†’ PASS!

// Admin trying to add deal for someone else
const adminDeal = { user_id: "rep-456", value: 2000 };
await supabase.from("sales_deals").insert(adminDeal);
// âœ… Policy 2 checks: Is user an admin? â†’ PASS! (no user_id check needed)
```

### Enable RLS on Table

```sql
ALTER TABLE public.sales_deals ENABLE ROW LEVEL SECURITY;
```

âš ï¸ **Without this, policies won't work!**

---

## ðŸ”„ Realtime Subscriptions {#realtime}

> **What is Realtime?**  
> Listen for database changes in real-time (like WebSockets but easier!)

### Our Realtime Setup

```javascript
useEffect(() => {
  // Listen for ALL changes in sales_deals table
  const channel = supabase
    .channel("deal-changes")
    .on(
      "postgres_changes",
      {
        event: "*",              // INSERT, UPDATE, DELETE, or *
        schema: "public",
        table: "sales_deals",
      },
      (payload) => {
        console.log(payload);
        fetchMetrics();          // Re-fetch data when change happens
      }
    )
    .subscribe();

  // Cleanup: remove listener when component unmounts
  return () => {
    supabase.removeChannel(channel);
  };
}, []);
```

### How It Works

```
User A adds a deal â†’ Database updates
              â†“
    ðŸ”” Supabase broadcasts event
              â†“
    User B's browser receives event
              â†“
    fetchMetrics() runs automatically
              â†“
    User B sees updated chart!
```

### Event Types

| Event | When it fires |
|-------|---------------|
| `INSERT` | New row added |
| `UPDATE` | Row modified |
| `DELETE` | Row deleted |
| `*` | Any change (all events) |

---

## ðŸ§© SQL JOINs {#joins}

> **What is a JOIN?**  
> Combining data from multiple tables based on a relationship

### SQL JOIN Syntax (Raw SQL)

```sql
-- Get rep names with their total sales
SELECT
  user_profiles.name,
  sum(sales_deals.value)
FROM sales_deals
INNER JOIN user_profiles ON user_profiles.id = sales_deals.user_id
GROUP BY user_profiles.name;
```

**Result:**
```
name    | sum
--------|------
Jim     | 5000
Sakshi  | 3500
bob     | 1200
```

### Supabase JOIN Syntax (JavaScript)

```javascript
const { data, error } = await supabase
  .from("sales_deals")
  .select(`
    value.sum(),
    ...user_profiles!inner(name)
  `);
```

**Result:**
```javascript
[
  { sum: 5000, name: "Jim" },
  { sum: 3500, name: "Sakshi" },
  { sum: 1200, name: "bob" }
]
```

### The Magic Spread Operator `...`

- **Without `...`:** `{ sum: 5000, user_profiles: { name: "Jim" } }` (nested)
- **With `...`:** `{ sum: 5000, name: "Jim" }` (flat) âœ…

### Why `!inner` Works

`!inner` = INNER JOIN  
Requires **foreign key relationship** to exist!

```sql
-- Must have this FK for Supabase JOIN to work
ALTER TABLE sales_deals 
ADD CONSTRAINT sales_deals_user_id_fkey 
FOREIGN KEY (user_id) REFERENCES user_profiles(id);
```

---

## ðŸŽ¯ Putting It All Together

### The Complete Flow

```
1. ðŸ” User signs up
   â†“
2. âš¡ Trigger creates profile in user_profiles
   â†“
3. ðŸ›¡ï¸ RLS policies check user's account_type
   â†“
4. âœ… Rep adds deal (only their own)
   â†“
5. ðŸ”— FK validates user_id exists
   â†“
6. ðŸ’¾ Deal inserted into sales_deals
   â†“
7. ðŸ”„ Realtime notifies all connected users
   â†“
8. ðŸ§© JOIN fetches names + sums for chart
   â†“
9. ðŸ“Š Chart updates with new data!
```

---

## ðŸ’¡ Key Takeaways

| Concept | Purpose | Key Benefit |
|---------|---------|-------------|
| **Authentication** | User login/logout | Secure user sessions |
| **Triggers** | Auto-create profiles | No manual sync needed |
| **Foreign Keys** | Link tables | Data integrity + JOINs |
| **RLS Policies** | Access control | Database-level security |
| **Realtime** | Live updates | Instant UI sync |
| **JOINs** | Combine tables | Get related data easily |

---

## ðŸš€ Quick Reference

### Check if FK exists
```sql
SELECT * FROM information_schema.table_constraints 
WHERE table_name = 'sales_deals';
```

### Drop and recreate policy
```sql
DROP POLICY IF EXISTS "policy_name" ON table_name;
CREATE POLICY...
```

### Test realtime in console
```javascript
supabase
  .channel('test')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'sales_deals' }, 
    payload => console.log(payload))
  .subscribe();
```

---

**ðŸŽ“ Remember:** Supabase = PostgreSQL + Auth + Realtime + Security, all in one! ï¿½
